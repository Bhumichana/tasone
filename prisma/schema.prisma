// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  password     String
  userGroup    String // "HeadOffice" หรือ "Dealer"
  role         String
  firstName    String
  lastName     String
  phoneNumber  String
  email        String? // อีเมลของผู้ใช้งาน
  lineId       String? // LINE ID ของผู้ใช้งาน
  profileImage String? // URL ของรูปประจำตัว
  dealerId     String?
  dealer       Dealer?  @relation(fields: [dealerId], references: [id])
  isActive     Boolean  @default(false) // สถานะการเปิดใช้งาน (ต้องรอ Admin อนุมัติ)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

model Dealer {
  id                 String               @id @default(cuid())
  dealerCode         String               @unique
  manufacturerNumber String
  dealerName         String
  type               String               @default("ตัวแทนจำหน่าย") // "สำนักงานใหญ่" หรือ "ตัวแทนจำหน่าย"
  region             String? // ตัวแทนจำหน่ายภาค
  address            String
  phoneNumber        String
  startDate          DateTime? // เปลี่ยนเป็น optional
  endDate            DateTime?
  users              User[]
  warranties         Warranty[]
  subDealers         SubDealer[] // ผู้ขายรายย่อยภายใต้ดีลเลอร์
  materialDeliveries MaterialDelivery[] // การส่งมอบวัตถุดิบที่ได้รับ
  dealerReceipts     DealerReceipt[] // ใบรับสินค้าของดีลเลอร์
  dealerStock        DealerStock[] // สต็อกวัตถุดิบของดีลเลอร์
  notifications      DealerNotification[] // การแจ้งเตือนของดีลเลอร์
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@map("dealers")
}

// ผู้ขายรายย่อยภายใต้ดีลเลอร์ (ไม่ต้อง login)
model SubDealer {
  id          String     @id @default(cuid())
  name        String // ชื่อผู้ขายรายย่อย
  address     String? // ที่อยู่
  phoneNumber String? // เบอร์โทร
  email       String? // อีเมล
  dealerId    String // ดีลเลอร์เจ้าของ
  dealer      Dealer     @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  warranties  Warranty[] // การรับประกันที่เกิดจาก Sub-dealer นี้
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("sub_dealers")
}

model RawMaterial {
  id            String                 @id @default(cuid())
  materialCode  String                 @unique
  materialName  String
  materialType  String
  description   String?
  unit          String // หน่วยของวัตถุดิบ (เช่น กก., ชิ้น, เมตร)
  supplier      String? // ชื่อผู้จัดหา/บริษัท
  location      String? // สถานที่จัดเก็บ
  expiryDate    DateTime? // วันหมดอายุ
  batchNumber   String? // หมายเลข Batch/Lot
  currentStock  Float                  @default(0)
  minStock      Float                  @default(0)
  receivings    RawMaterialReceiving[] // เพิ่ม relation กับ receiving
  batches       RawMaterialBatch[] // Batch ทั้งหมดของวัตถุดิบนี้
  deliveryItems MaterialDeliveryItem[] // รายการส่งมอบวัตถุดิบ
  recipeItems   ProductRecipeItem[] // เพิ่มรายการในสูตรการผลิต
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@map("raw_materials")
}

model Product {
  id            String         @id @default(cuid())
  productCode   String         @unique
  productName   String
  serialNumber  String?        @unique
  category      String
  description   String?
  warrantyTerms String? // เงื่อนไขการรับประกันมาตรฐาน
  thickness     Float? // ความหนา (mm.) สำหรับคำนวณตัดสต็อกวัตถุดิบ
  templateImage String? @default("Certification-Form.jpg") // เทมเพลทใบรับประกัน
  warranties    Warranty[]
  recipe        ProductRecipe? // เพิ่มสูตรการผลิต
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("products")
}

model Warranty {
  id                   String   @id @default(cuid())
  warrantyNumber       String   @unique
  productId            String
  product              Product  @relation(fields: [productId], references: [id])
  customerName         String
  customerPhone        String
  customerEmail        String?
  customerAddress      String
  warrantyDate         DateTime
  expiryDate           DateTime
  warrantyPeriodMonths Int
  warrantyTerms        String?

  // ข้อมูลเพิ่มเติม
  dealerName       String? // ชื่อผู้จำหน่าย
  productionDate   DateTime? // วันที่ผลิต
  deliveryDate     DateTime? // วันที่ส่งมอบ
  purchaseOrderNo  String? // เลขที่ใบสั่งซื้อ
  installationArea Float? // พื้นที่ติดตั้งฉนวน (ตารางเมตร)
  thickness        Float? // ความหนา (มิลลิเมตร)
  chemicalBatchNo  String? // หมายเลข Batch สารเคมี
  materialUsage    String? // ข้อมูลวัตถุดิบที่ใช้ (JSON format)

  dealerId    String
  dealer      Dealer     @relation(fields: [dealerId], references: [id])
  subDealerId String? // ผู้ขายรายย่อย (optional)
  subDealer   SubDealer? @relation(fields: [subDealerId], references: [id])

  // ระบบควบคุมการแก้ไข
  isEdited  Boolean  @default(false) // แก้ไขแล้วหรือยัง
  editedAt  DateTime? // วันที่แก้ไข
  editedBy  String? // ผู้แก้ไข (username หรือ user id)

  // ระบบอนุมัติการแก้ไข (Approval System)
  editStatus       String?   @default("active") // "active", "pending_edit_approval", "edit_approved"
  editRequestedAt  DateTime? // วันที่ส่งคำขอแก้ไข
  editApproved     Boolean?  // สถานะการอนุมัติการแก้ไข (true = อนุมัติ, false = ปฏิเสธ, null = รอการอนุมัติ)
  editApprovedAt   DateTime? // วันที่อนุมัติ
  editApprovedBy   String?   // ผู้อนุมัติ (username)
  approvalNote     String?   // หมายเหตุการอนุมัติ
  editReason       String?   // เหตุผลในการแก้ไข

  // History การแก้ไข
  history WarrantyHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warranties")
}

model RawMaterialReceiving {
  id              String   @id @default(cuid())
  receivingNumber String   @unique // เลขที่ใบนำเข้า (HQ-RCV-YYYYMMDD-XXX)
  receivingDate   DateTime // วันที่รับเข้าสินค้า
  purchaseOrderNo String? // เลขที่ใบสั่งซื้อ (optional)

  // ข้อมูลผู้ผลิต/ผู้ขาย
  supplier String // ผู้ผลิต/ผู้ขาย

  // ข้อมูลวัตถุดิบ
  rawMaterialId String // เชื่อมต่อกับตารางวัตถุดิบ
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])

  batchNumber      String // Batch No.
  receivedQuantity Float // ปริมาณที่รับเข้า (kg)
  storageLocation  String // สถานที่จัดเก็บในคลังสำนักงานใหญ่
  expiryDate       DateTime? // วันหมดอายุ (optional)

  // ข้อมูลเพิ่มเติม
  qualityStatus String  @default("PENDING") // สถานะการตรวจสอบคุณภาพ (PENDING, APPROVED, REJECTED)
  notes         String? // หมายเหตุ
  receivedBy    String // เจ้าหน้าที่ผู้รับเข้า (Head Office)

  // Batch ที่สร้างจากการรับเข้านี้
  batches RawMaterialBatch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("raw_material_receiving")
}

// Batch สต็อกวัตถุดิบ (แยกตาม Batch Number)
model RawMaterialBatch {
  id String @id @default(cuid())

  // เชื่อมต่อกับวัตถุดิบ
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])

  // เชื่อมต่อกับการรับเข้า
  receivingId String
  receiving   RawMaterialReceiving @relation(fields: [receivingId], references: [id])

  // ข้อมูล Batch
  batchNumber     String // เลข Batch
  initialQuantity Float // ปริมาณเริ่มต้น
  currentStock    Float // สต็อกปัจจุบัน
  unit            String // หน่วย (kg, ชิ้น, ฯลฯ)

  // ข้อมูลเพิ่มเติม
  supplier        String // ผู้จัดหา
  receivedDate    DateTime // วันที่รับเข้า
  expiryDate      DateTime? // วันหมดอายุ (ถ้ามี)
  storageLocation String // สถานที่จัดเก็บ

  // สถานะ
  status String @default("AVAILABLE") // AVAILABLE, OUT_OF_STOCK, EXPIRED

  // ระบบต่ออายุวัตถุดิบ (Material Re-certification)
  isRecertified        Boolean   @default(false) // ต่ออายุแล้วหรือไม่
  recertificationCount Int       @default(0) // จำนวนครั้งที่ต่ออายุ
  lastRecertifiedAt    DateTime? // วันที่ต่ออายุล่าสุด
  lastRecertifiedBy    String? // ผู้ต่ออายุล่าสุด

  // รายการส่งมอบที่ใช้ Batch นี้
  deliveryItems MaterialDeliveryItem[]

  // ประวัติการต่ออายุ
  recertificationHistory RecertificationHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ไม่ให้มี Batch ซ้ำในวัตถุดิบเดียวกัน
  @@unique([rawMaterialId, batchNumber])
  @@map("raw_material_batches")
}

// หัวรายการส่งมอบวัตถุดิบ (ครั้งเดียวต่อการส่งมอบ)
model MaterialDelivery {
  id             String   @id @default(cuid())
  deliveryNumber String   @unique // เลขที่การส่งมอบ (DEL-YYYYMMDD-XXX)
  deliveryDate   DateTime // วันที่ส่งมอบ
  dealerId       String // ตัวแทนจำหน่ายที่รับวัตถุดิบ
  dealer         Dealer   @relation(fields: [dealerId], references: [id])
  status         String   @default("PENDING_RECEIPT") // สถานะการส่งมอบ (PENDING_RECEIPT = รอดีลเลอร์รับเข้า, DELIVERED = ส่งแล้ว)
  totalItems     Int      @default(0) // จำนวนรายการวัตถุดิบทั้งหมด
  notes          String? // หมายเหตุ

  // รายการวัตถุดิบในการส่งมอบนี้
  items MaterialDeliveryItem[]

  // ใบรับที่เชื่อมต่อกับการส่งมอบนี้
  dealerReceipt DealerReceipt?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("material_deliveries")
}

// รายการวัตถุดิบในแต่ละการส่งมอบ
model MaterialDeliveryItem {
  id            String           @id @default(cuid())
  deliveryId    String // เชื่อมต่อกับหัวรายการส่งมอบ
  delivery      MaterialDelivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  rawMaterialId String // วัตถุดิบที่ส่งมอบ
  rawMaterial   RawMaterial      @relation(fields: [rawMaterialId], references: [id])

  // เชื่อมต่อกับ Batch
  batchId     String? // Batch ที่ส่งมอบ (optional สำหรับข้อมูลเก่า)
  batch       RawMaterialBatch? @relation(fields: [batchId], references: [id])
  batchNumber String // Batch Number

  quantity Float // ปริมาณที่ส่งมอบ
  unit     String // หน่วย (kg, ชิ้น, เมตร ฯลฯ)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("material_delivery_items")
}

// ใบรับสินค้าของดีลเลอร์
model DealerReceipt {
  id                 String           @id @default(cuid())
  receiptNumber      String           @unique // เลขที่ใบรับ (RCP-DEALER-YYYYMMDD-XXX)
  materialDeliveryId String           @unique // เชื่อมต่อกับการส่งมอบ (one-to-one)
  materialDelivery   MaterialDelivery @relation(fields: [materialDeliveryId], references: [id])
  dealerId           String // ดีลเลอร์ที่รับสินค้า
  dealer             Dealer           @relation(fields: [dealerId], references: [id])
  receiptDate        DateTime // วันที่รับสินค้า
  receivedBy         String // ผู้รับสินค้า (ชื่อเจ้าหน้าที่ของดีลเลอร์)
  status             String           @default("RECEIVED") // สถานะ (RECEIVED)
  notes              String? // หมายเหตุ

  // รายการสินค้าที่รับ
  items DealerReceiptItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dealer_receipts")
}

// รายการสินค้าในใบรับของดีลเลอร์
model DealerReceiptItem {
  id               String        @id @default(cuid())
  receiptId        String // เชื่อมต่อกับใบรับ
  receipt          DealerReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  rawMaterialId    String // วัตถุดิบที่รับ
  batchNumber      String // Batch Number
  quantity         Float // ปริมาณที่รับ
  unit             String // หน่วย
  receivedQuantity Float // ปริมาณที่รับจริง (อาจต่างจากที่ส่ง)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dealer_receipt_items")
}

// สต็อกวัตถุดิบของดีลเลอร์
model DealerStock {
  id           String   @id @default(cuid())
  dealerId     String // ดีลเลอร์เจ้าของสต็อก
  dealer       Dealer   @relation(fields: [dealerId], references: [id])
  materialCode String // รหัสวัตถุดิบ
  materialName String // ชื่อวัตถุดิบ
  materialType String // ประเภทวัตถุดิบ
  batchNumber  String // Batch Number
  currentStock Float    @default(0) // สต็อกปัจจุบัน
  unit         String // หน่วย
  expiryDate   DateTime? // วันหมดอายุของ batch นี้
  lastUpdated  DateTime @default(now()) // วันที่อัปเดตล่าสุด

  // สถานะ
  status String @default("AVAILABLE") // AVAILABLE, OUT_OF_STOCK, EXPIRED

  // ระบบต่ออายุวัตถุดิบของดีลเลอร์ (Material Re-certification)
  isRecertified        Boolean   @default(false) // ต่ออายุแล้วหรือไม่
  recertificationCount Int       @default(0) // จำนวนครั้งที่ต่ออายุ
  lastRecertifiedAt    DateTime? // วันที่ต่ออายุล่าสุด
  lastRecertifiedBy    String? // ผู้ต่ออายุล่าสุด

  // ประวัติการต่ออายุของดีลเลอร์
  recertificationHistory DealerRecertificationHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ไม่ให้มี materialCode และ batchNumber ซ้ำในดีลเลอร์เดียวกัน
  @@unique([dealerId, materialCode, batchNumber])
  @@map("dealer_stock")
}

// การแจ้งเตือนสำหรับดีลเลอร์
model DealerNotification {
  id       String    @id @default(cuid())
  dealerId String // ดีลเลอร์ที่ได้รับการแจ้งเตือน
  dealer   Dealer    @relation(fields: [dealerId], references: [id])
  type     String // ประเภทการแจ้งเตือน (INCOMING_MATERIALS, SYSTEM_MESSAGE)
  title    String // หัวข้อการแจ้งเตือน
  message  String // ข้อความ
  data     String? // ข้อมูลเพิ่มเติม (JSON format)
  isRead   Boolean   @default(false) // อ่านแล้วหรือยัง
  readAt   DateTime? // วันที่อ่าน

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dealer_notifications")
}

// การแจ้งเตือนสำหรับสำนักงานใหญ่ (HeadOffice)
model HeadOfficeNotification {
  id               String    @id @default(cuid())
  type             String // ประเภทการแจ้งเตือน (EDIT_REQUEST, SYSTEM_MESSAGE)
  notificationType String? // ประเภทย่อย เช่น "EDIT_REQUEST"
  title            String // หัวข้อการแจ้งเตือน
  message          String // ข้อความ
  data             String? // ข้อมูลเพิ่มเติม (JSON format - เช่น warrantyId, dealerId)
  warrantyId       String? // ID ของใบรับประกันที่เกี่ยวข้อง
  status           String    @default("PENDING") // สถานะ (PENDING, APPROVED, REJECTED)
  isRead           Boolean   @default(false) // อ่านแล้วหรือยัง
  readAt           DateTime? // วันที่อ่าน
  resolvedAt       DateTime? // วันที่แก้ไข/อนุมัติ
  resolvedBy       String? // ผู้แก้ไข/อนุมัติ
  resolvedNote     String? // หมายเหตุการแก้ไข

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("headoffice_notifications")
}

// สูตรการผลิตสินค้า
model ProductRecipe {
  id              String  @id @default(cuid())
  productId       String  @unique // One-to-One กับ Product
  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  recipeName      String // ชื่อสูตร เช่น "สูตรมาตรฐาน", "สูตร A"
  version         String  @default("1.0")
  description     String? // คำอธิบายสูตร
  isActive        Boolean @default(true)
  calculationUnit String  @default("PER_UNIT") // "PER_UNIT" = ต่อหน่วย, "PER_SQM" = ต่อตารางเมตร

  items ProductRecipeItem[] // รายการวัตถุดิบ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_recipes")
}

// รายการวัตถุดิบในสูตรการผลิต
model ProductRecipeItem {
  id            String        @id @default(cuid())
  recipeId      String
  recipe        ProductRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterialId String
  rawMaterial   RawMaterial   @relation(fields: [rawMaterialId], references: [id])
  quantity      Float // ปริมาณที่ต้องใช้
  unit          String // หน่วย
  notes         String? // หมายเหตุ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_recipe_items")
}

// ประวัติการแก้ไขใบรับประกัน (Audit Trail)
model WarrantyHistory {
  id         String   @id @default(cuid())
  warrantyId String
  warranty   Warranty @relation(fields: [warrantyId], references: [id], onDelete: Cascade)

  // ผู้ทำรายการ
  editedBy       String // username หรือ userId
  editedByName   String // ชื่อผู้แก้ไข
  editedByGroup  String // HeadOffice หรือ Dealer

  // ข้อมูลที่เปลี่ยนแปลง (JSON format)
  changesSummary String // สรุปการเปลี่ยนแปลง เช่น "แก้ไขชื่อลูกค้า, เบอร์โทร"
  oldData        String // ข้อมูลเก่า (JSON)
  newData        String // ข้อมูลใหม่ (JSON)

  // เหตุผลในการแก้ไข (optional)
  reason String? // เหตุผลในการแก้ไข

  createdAt DateTime @default(now())

  @@map("warranty_history")
}

// ประวัติการต่ออายุวัตถุดิบ (Material Re-certification History)
model RecertificationHistory {
  id String @id @default(cuid())

  // เชื่อมต่อกับ Batch
  batchId String
  batch   RawMaterialBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // ข้อมูลการต่ออายุ
  oldExpiryDate DateTime // วันหมดอายุเดิม
  newExpiryDate DateTime // วันหมดอายุใหม่
  extendedDays  Int      @default(60) // จำนวนวันที่ต่อ (default 60)

  // ผู้ทำรายการ
  recertifiedBy     String // Admin ผู้ต่ออายุ (username)
  recertifiedByName String // ชื่อ Admin
  reason            String? // เหตุผล (optional)
  note              String? // หมายเหตุเพิ่มเติม (optional)

  createdAt DateTime @default(now())

  @@map("recertification_history")
}

// ประวัติการต่ออายุวัตถุดิบของดีลเลอร์ (Dealer Material Re-certification History)
model DealerRecertificationHistory {
  id String @id @default(cuid())

  // เชื่อมต่อกับ DealerStock
  dealerStockId String
  dealerStock   DealerStock @relation(fields: [dealerStockId], references: [id], onDelete: Cascade)

  // ข้อมูลการต่ออายุ
  oldExpiryDate DateTime // วันหมดอายุเดิม
  newExpiryDate DateTime // วันหมดอายุใหม่
  extendedDays  Int      @default(60) // จำนวนวันที่ต่อ (default 60)

  // ผู้ทำรายการ
  recertifiedBy     String // Admin ผู้ต่ออายุ (username)
  recertifiedByName String // ชื่อ Admin
  reason            String? // เหตุผล (optional)
  note              String? // หมายเหตุเพิ่มเติม (optional)

  createdAt DateTime @default(now())

  @@map("dealer_recertification_history")
}
